# AI åŠ©æ‰‹æ ¸å¿ƒè§„åˆ™

Always respond in Chinese.

## ä¸‰é˜¶æ®µå·¥ä½œæµ

### é˜¶æ®µä¸€ï¼šåˆ†æé—®é¢˜

**å£°æ˜æ ¼å¼**ï¼š`ã€åˆ†æé—®é¢˜ã€‘`

**å¿…é¡»åšçš„äº‹**ï¼š

- æ·±å…¥ç†è§£éœ€æ±‚æœ¬è´¨
- æœç´¢æ‰€æœ‰ç›¸å…³ä»£ç 
- è¯†åˆ«é—®é¢˜æ ¹å› 
- å‘ç°æ¶æ„é—®é¢˜
- å¦‚æœæœ‰ä¸æ¸…æ¥šçš„ï¼Œè¯·å‘æˆ‘æ”¶é›†å¿…è¦çš„ä¿¡æ¯
- æä¾›1~3ä¸ªè§£å†³æ–¹æ¡ˆï¼ˆå¦‚æœæ–¹æ¡ˆä¸ç”¨æˆ·æƒ³è¾¾æˆçš„ç›®æ ‡æœ‰å†²çªï¼Œåˆ™ä¸åº”è¯¥æˆä¸ºä¸€ä¸ªæ–¹æ¡ˆï¼‰
- è¯„ä¼°æ¯ä¸ªæ–¹æ¡ˆçš„ä¼˜åŠ£

**èå…¥çš„åŸåˆ™**ï¼š

- ç³»ç»Ÿæ€§æ€ç»´ï¼šçœ‹åˆ°å…·ä½“é—®é¢˜æ—¶ï¼Œæ€è€ƒæ•´ä¸ªç³»ç»Ÿ
- ç¬¬ä¸€æ€§åŸåˆ™ï¼šä»åŠŸèƒ½æœ¬è´¨å‡ºå‘ï¼Œè€Œä¸æ˜¯ç°æœ‰ä»£ç 
- DRYåŸåˆ™ï¼šå‘ç°é‡å¤ä»£ç å¿…é¡»æŒ‡å‡º
- é•¿è¿œè€ƒè™‘ï¼šè¯„ä¼°æŠ€æœ¯å€ºåŠ¡å’Œç»´æŠ¤æˆæœ¬

**ç»å¯¹ç¦æ­¢**ï¼š

- âŒ ä¿®æ”¹ä»»ä½•ä»£ç 
- âŒ æ€¥äºç»™å‡ºè§£å†³æ–¹æ¡ˆ
- âŒ è·³è¿‡æœç´¢å’Œç†è§£æ­¥éª¤
- âŒ ä¸åˆ†æå°±æ¨èæ–¹æ¡ˆ

### é˜¶æ®µäºŒï¼šç»†åŒ–æ–¹æ¡ˆ

**å£°æ˜æ ¼å¼**ï¼š`ã€ç»†åŒ–æ–¹æ¡ˆã€‘`

**å‰ç½®æ¡ä»¶**ï¼š

- ç”¨æˆ·æ˜ç¡®é€‰æ‹©äº†æ–¹æ¡ˆï¼ˆå¦‚ï¼š"ç”¨æ–¹æ¡ˆ1"ã€"å®ç°è¿™ä¸ª"ï¼‰

**å¿…é¡»åšçš„äº‹**ï¼š

- åˆ—å‡ºå˜æ›´ï¼ˆæ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤ï¼‰çš„æ–‡ä»¶ï¼Œç®€è¦æè¿°æ¯ä¸ªæ–‡ä»¶çš„å˜åŒ–

### é˜¶æ®µä¸‰ï¼šæ‰§è¡Œæ–¹æ¡ˆ

**å£°æ˜æ ¼å¼**ï¼š`ã€æ‰§è¡Œæ–¹æ¡ˆã€‘`

**å¿…é¡»åšçš„äº‹**ï¼š

- ä¸¥æ ¼æŒ‰ç…§é€‰å®šæ–¹æ¡ˆå®ç°
- ä¿®æ”¹åè¿è¡Œä»£ç æ ¼å¼åŒ–ï¼ˆpnpm formatï¼‰ã€æ„å»ºï¼ˆpnpm buildï¼‰

**ç»å¯¹ç¦æ­¢**ï¼š

- âŒ æäº¤ä»£ç ï¼ˆé™¤éç”¨æˆ·æ˜ç¡®è¦æ±‚ï¼‰
- å¯åŠ¨å¼€å‘æœåŠ¡å™¨

## ğŸš¨ é˜¶æ®µåˆ‡æ¢è§„åˆ™

1. **é»˜è®¤é˜¶æ®µ**ï¼šæ”¶åˆ°æ–°é—®é¢˜æ—¶ï¼Œå§‹ç»ˆä»ã€åˆ†æé—®é¢˜ã€‘å¼€å§‹
2. **åˆ‡æ¢æ¡ä»¶**ï¼šåªæœ‰ç”¨æˆ·æ˜ç¡®æŒ‡ç¤ºæ—¶æ‰èƒ½åˆ‡æ¢é˜¶æ®µ
3. **ç¦æ­¢è¡Œä¸º**ï¼šä¸å…è®¸åœ¨ä¸€æ¬¡å›å¤ä¸­åŒæ—¶è¿›è¡Œä¸¤ä¸ªé˜¶æ®µ

## âš ï¸ æ¯æ¬¡å›å¤å‰çš„å¼ºåˆ¶æ£€æŸ¥

```
â–¡ æˆ‘åœ¨å›å¤å¼€å¤´å£°æ˜äº†é˜¶æ®µå—ï¼Ÿ
â–¡ æˆ‘çš„è¡Œä¸ºç¬¦åˆå½“å‰é˜¶æ®µå—ï¼Ÿ
â–¡ å¦‚æœè¦åˆ‡æ¢é˜¶æ®µï¼Œç”¨æˆ·åŒæ„äº†å—ï¼Ÿ
```

---

# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

### Core Development

- `pnpm install` - Install dependencies
- `pnpm run start:dev` - Start development server with hot reload
- `pnpm run start:debug` - Start development server with debug mode
- `pnpm run build` - Build production bundle
- `pnpm run start:prod` - Start production server

### Testing

- `pnpm run test` - Run unit tests
- `pnpm run test:watch` - Run tests in watch mode
- `pnpm run test:cov` - Run tests with coverage report
- `pnpm run test:e2e` - Run end-to-end tests
- `pnpm run test:debug` - Run tests in debug mode

### Code Quality

- `pnpm run lint` - Run ESLint and fix issues
- `pnpm run format` - Format code with Prettier

### Documentation

- `pnpm run docs:dev` - Start VitePress docs in development mode
- `pnpm run docs:build` - Build documentation
- `pnpm run docs:preview` - Preview built documentation
- `pnpm run docs:serve` - Serve documentation with auto-open

### Docker Development

- `docker-compose up -d` - Start development environment
- `docker-compose -f docker-compose.prod.yml up -d` - Start production environment

## Project Architecture

This is a NestJS-based enterprise information management system with modular architecture:

### Core Structure

- **Framework**: NestJS with TypeScript
- **Database**: MySQL with TypeORM
- **Authentication**: JWT + Contract Token system
- **Storage**: MinIO object storage
- **Documentation**: VitePress + Swagger API docs

### Module Organization

The application follows a domain-driven modular design:

#### Authentication & Authorization (auth module)

- JWT-based user authentication
- Contract token system for non-authenticated access
- Role-based access control (RBAC)
- Combined authentication guard supporting both JWT and contract tokens

#### Core Business Modules

- **users**: User management with role assignment and departmental association
- **customer**: Customer information management with categorization
- **department**: Organizational structure management
- **roles/permissions**: RBAC implementation
- **expense**: Financial expense tracking and reporting
- **contract**: Contract management with digital signature capabilities
- **employee**: Employee information management
- **enterprise-service**: Comprehensive enterprise services including:
  - Service history tracking
  - Change history management
  - Financial self-inspection
  - Tax verification

#### Infrastructure Modules

- **storage**: File upload/download with MinIO integration
- **database**: TypeORM configuration and database management
- **config**: Centralized configuration management

### Key Architectural Patterns

#### Authentication Strategy

The system implements dual authentication:

1. **JWT Authentication**: Standard user login with bearer tokens
2. **Contract Token Authentication**: Temporary tokens for specific contract-related operations

#### Permission System

- Role-based permissions with granular access control
- Module-specific permission services (e.g., `customer-permission.service.ts`)
- Guard-based route protection

#### File Storage

- MinIO-based object storage with permanent URL generation
- Support for authenticated file uploads via both JWT and contract tokens
- Automatic filename timestamping for conflict resolution

#### Error Handling & Response Format

- Global exception filter (`http-exception.filter.ts`)
- Transform interceptor for consistent API responses
- Comprehensive validation using class-validator DTOs

## Important Development Notes

### Database Configuration

- Entity synchronization controlled by `DB_SYNCHRONIZE` environment variable
- Timezone set to UTC in TypeORM configuration
- All entities registered in `app.module.ts`

### Environment Configuration

Key environment variables (see `.env.example`):

- Database: `DB_HOST`, `DB_PORT`, `DB_USERNAME`, `DB_PASSWORD`, `DB_DATABASE`
- JWT: `JWT_SECRET`, `JWT_EXPIRES_IN`
- Application: `APP_PORT`, `APP_ENV`, `LOG_LEVEL`, `CORS_ORIGIN`
- MinIO: `MINIO_ENDPOINT`, `MINIO_ACCESS_KEY`, `MINIO_SECRET_KEY`, `MINIO_BUCKET`

### API Documentation

- Swagger UI available at `/api/docs` in non-production environments
- API prefix `/api` set globally
- Comprehensive DTO documentation with validation rules

### Logging System

- Custom logger extending ConsoleLogger
- File-based logging to `./logs/` directory with daily rotation
- Configurable log levels: error, warn, info, debug

### Development Workflow

1. Always run `pnpm run lint` before committing
2. Use `pnpm run test` to ensure tests pass
3. Follow the existing module structure when adding new features
4. Implement DTOs with proper validation for all endpoints
5. Add proper error handling and response transformation
