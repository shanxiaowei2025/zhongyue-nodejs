# 客户等级历史管理模块

## 功能概述

本模块实现了客户等级变更历史的记录和查询功能，解决了报表统计中需要获取客户在特定时间点等级状态的需求。

## 主要功能

### 1. 客户等级历史记录
- 自动记录客户等级变更历史
- 支持手动创建等级历史记录
- 记录变更原因、操作人员等详细信息

### 2. 历史数据查询
- 根据条件查询等级变更历史
- 获取客户在指定时间点的等级状态
- 批量查询多个客户的历史等级

### 3. 报表集成
- 客户等级分布统计支持历史数据
- 解决了时间参数查询的准确性问题

## 数据库表结构

### customer_level_history 表
- `id`: 主键
- `customerId`: 客户ID（外键）
- `companyName`: 企业名称（冗余字段）
- `unifiedSocialCreditCode`: 统一社会信用代码（冗余字段）
- `previousLevel`: 变更前等级
- `currentLevel`: 变更后等级
- `changeDate`: 变更日期
- `changeReason`: 变更原因
- `changedBy`: 操作人员
- `remarks`: 备注信息
- `createdAt`: 创建时间
- `updatedAt`: 更新时间

## API 接口

### 1. 创建等级历史记录
```
POST /api/reports/customer-level-history
```
管理员权限，手动创建等级历史记录。

### 2. 查询等级历史记录
```
GET /api/reports/customer-level-history
```
支持多种查询条件：客户ID、企业名称、时间范围等。

### 3. 查询特定客户的等级历史
```
GET /api/reports/customer-level-history/customer/:customerId
```
获取指定客户的所有等级变更历史。

### 4. 查询指定时间点的客户等级
```
GET /api/reports/customer-level-history/level-at-time?customerId=1&targetDate=2025-06-30
```
获取客户在特定日期的等级状态。

## 核心逻辑

### 1. 等级变更检测
当客户信息更新时，系统会自动检测 `customerLevel` 字段是否发生变化，如有变化则创建历史记录。

### 2. 历史等级查询
查询客户在指定时间点的等级时，系统会：
1. 查找小于等于目标日期的最新等级记录
2. 如果没有历史记录，则使用客户表中的当前等级
3. 支持批量查询以提高性能

### 3. 报表数据修正
在客户等级分布统计中：
- 如果查询参数包含年份或月份，使用历史数据
- 否则使用当前数据（保持原有逻辑）

## 使用示例

### 场景描述
A公司在2025年6月等级为AD，7月改为AC。现在查询2025年6月的客户等级分布统计。

### 解决方案
1. 系统在7月更新客户等级时，自动创建历史记录
2. 查询2025年6月数据时，系统会查找A公司在2025年6月30日的等级状态
3. 返回AD等级，而不是当前的AC等级

## 注意事项

1. **历史数据补录**: 对于系统上线前的数据，可能需要手动补录关键的等级变更历史
2. **性能考虑**: 批量查询历史等级时使用了优化的查询策略
3. **数据一致性**: 等级历史记录创建失败不会影响客户更新的主流程
4. **权限控制**: 继承了报表模块的权限控制机制

## 待完善功能

1. 客户服务中的等级历史服务集成（当前使用TODO标记）
2. 缓存策略优化
3. 数据导出功能
4. 更多的统计分析功能

## 技术实现

- **框架**: NestJS + TypeORM
- **数据库**: MySQL
- **架构模式**: 模块化设计，依赖注入
- **性能优化**: 批量查询、索引优化 