<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šçŸ¥ç³»ç»Ÿ WebSocket æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .notification {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”” é€šçŸ¥ç³»ç»Ÿ WebSocket æµ‹è¯•å·¥å…·</h1>
        
        <!-- è¿æ¥é…ç½® -->
        <div class="section">
            <h3>1. è¿æ¥é…ç½®</h3>
            <label>WebSocket æœåŠ¡å™¨åœ°å€:</label>
            <input type="text" id="serverUrl" value="http://localhost:3000/ws" placeholder="WebSocketæœåŠ¡å™¨åœ°å€">
            
            <label>JWT Token:</label>
            <input type="text" id="jwtToken" placeholder="è¯·è¾“å…¥JWT Token">
            
            <div id="connectionStatus" class="status disconnected">
                çŠ¶æ€: æœªè¿æ¥
            </div>
            
            <button id="connectBtn">è¿æ¥ WebSocket</button>
            <button id="disconnectBtn" disabled>æ–­å¼€è¿æ¥</button>
        </div>

        <!-- API æµ‹è¯• -->
        <div class="section">
            <h3>2. é€šçŸ¥APIæµ‹è¯•</h3>
            <label>API åŸºç¡€åœ°å€:</label>
            <input type="text" id="apiBase" value="http://localhost:3000/api/notifications" placeholder="APIåŸºç¡€åœ°å€">
            
            <div style="margin-top: 15px;">
                <h4>åˆ›å»ºé€šçŸ¥</h4>
                <input type="text" id="notifTitle" placeholder="é€šçŸ¥æ ‡é¢˜" value="æµ‹è¯•é€šçŸ¥">
                <textarea id="notifContent" placeholder="é€šçŸ¥å†…å®¹" rows="3">è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥ï¼Œç”¨äºéªŒè¯WebSocketæ¨é€åŠŸèƒ½ã€‚</textarea>
                <input type="text" id="targetUsers" placeholder="ç›®æ ‡ç”¨æˆ·ID (é€—å·åˆ†éš”ï¼Œå¦‚: 1,2,3)">
                <button id="createNotifBtn">åˆ›å»ºå¹¶æ¨é€é€šçŸ¥</button>
            </div>
            
            <div style="margin-top: 15px;">
                <h4>è·å–æˆ‘çš„é€šçŸ¥</h4>
                <button id="getNotifBtn">è·å–é€šçŸ¥åˆ—è¡¨</button>
                <button id="getNewNotifBtn">è·å–æœªè¯»é€šçŸ¥</button>
            </div>
        </div>

        <!-- æ¥æ”¶åˆ°çš„é€šçŸ¥ -->
        <div class="section">
            <h3>3. å®æ—¶é€šçŸ¥</h3>
            <div id="notifications"></div>
        </div>

        <!-- æ—¥å¿— -->
        <div class="section">
            <h3>4. è¿æ¥æ—¥å¿—</h3>
            <button id="clearLogBtn">æ¸…ç©ºæ—¥å¿—</button>
            <div id="log" class="log"></div>
        </div>
    </div>

    <!-- Socket.IO å®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let socket = null;
        let isConnected = false;

        // DOM å…ƒç´ 
        const serverUrlInput = document.getElementById('serverUrl');
        const jwtTokenInput = document.getElementById('jwtToken');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const logDiv = document.getElementById('log');
        const notificationsDiv = document.getElementById('notifications');

        // API ç›¸å…³å…ƒç´ 
        const apiBaseInput = document.getElementById('apiBase');
        const notifTitleInput = document.getElementById('notifTitle');
        const notifContentInput = document.getElementById('notifContent');
        const targetUsersInput = document.getElementById('targetUsers');
        const createNotifBtn = document.getElementById('createNotifBtn');
        const getNotifBtn = document.getElementById('getNotifBtn');
        const getNewNotifBtn = document.getElementById('getNewNotifBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');

        // æ—¥å¿—å‡½æ•°
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            isConnected = connected;
            connectionStatus.textContent = connected ? 'çŠ¶æ€: å·²è¿æ¥' : 'çŠ¶æ€: æœªè¿æ¥';
            connectionStatus.className = `status ${connected ? 'connected' : 'disconnected'}`;
            connectBtn.disabled = connected;
            disconnectBtn.disabled = !connected;
        }

        // è¿æ¥ WebSocket
        connectBtn.addEventListener('click', () => {
            const serverUrl = serverUrlInput.value.trim();
            const token = jwtTokenInput.value.trim();

            if (!serverUrl) {
                alert('è¯·è¾“å…¥WebSocketæœåŠ¡å™¨åœ°å€');
                return;
            }

            if (!token) {
                alert('è¯·è¾“å…¥JWT Token');
                return;
            }

            addLog(`æ­£åœ¨è¿æ¥åˆ° ${serverUrl}...`);

            // åˆ›å»º Socket.IO è¿æ¥
            socket = io(serverUrl, {
                auth: {
                    token: token
                }
            });

            // è¿æ¥æˆåŠŸ
            socket.on('connect', () => {
                addLog('âœ… WebSocket è¿æ¥æˆåŠŸ');
                addLog(`Socket ID: ${socket.id}`);
                updateConnectionStatus(true);
            });

            // è¿æ¥å¤±è´¥
            socket.on('connect_error', (error) => {
                addLog(`âŒ è¿æ¥å¤±è´¥: ${error.message}`);
                updateConnectionStatus(false);
            });

            // æ–­å¼€è¿æ¥
            socket.on('disconnect', (reason) => {
                addLog(`ğŸ”Œ è¿æ¥æ–­å¼€: ${reason}`);
                updateConnectionStatus(false);
            });

            // æ¥æ”¶æ–°é€šçŸ¥
            socket.on('new-notification', (notification) => {
                addLog(`ğŸ“¬ æ”¶åˆ°æ–°é€šçŸ¥: ${notification.title}`);
                addNotificationToUI(notification);
            });

            // å…¶ä»–äº‹ä»¶
            socket.onAny((eventName, ...args) => {
                if (eventName !== 'new-notification') {
                    addLog(`ğŸ“¨ æ”¶åˆ°äº‹ä»¶ ${eventName}: ${JSON.stringify(args)}`);
                }
            });
        });

        // æ–­å¼€è¿æ¥
        disconnectBtn.addEventListener('click', () => {
            if (socket) {
                socket.disconnect();
                socket = null;
                addLog('ğŸ”Œ ä¸»åŠ¨æ–­å¼€è¿æ¥');
                updateConnectionStatus(false);
            }
        });

        // æ·»åŠ é€šçŸ¥åˆ°UI
        function addNotificationToUI(notification) {
            const notifDiv = document.createElement('div');
            notifDiv.className = 'notification';
            notifDiv.innerHTML = `
                <strong>${notification.title}</strong><br>
                ${notification.content}<br>
                <small>æ—¶é—´: ${new Date().toLocaleString()}</small>
            `;
            notificationsDiv.insertBefore(notifDiv, notificationsDiv.firstChild);
        }

        // API è¯·æ±‚è¾…åŠ©å‡½æ•°
        async function apiRequest(method, url, data = null) {
            const token = jwtTokenInput.value.trim();
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(url, options);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || 'è¯·æ±‚å¤±è´¥');
                }
                
                return result;
            } catch (error) {
                addLog(`âŒ APIè¯·æ±‚å¤±è´¥: ${error.message}`);
                throw error;
            }
        }

        // åˆ›å»ºé€šçŸ¥
        createNotifBtn.addEventListener('click', async () => {
            const title = notifTitleInput.value.trim();
            const content = notifContentInput.value.trim();
            const targetUsers = targetUsersInput.value.trim();

            if (!title || !content) {
                alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
                return;
            }

            const data = {
                title: title,
                content: content,
                type: 'test'
            };

            // è§£æç›®æ ‡ç”¨æˆ·
            if (targetUsers) {
                data.targetUsers = targetUsers.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
            }

            try {
                addLog(`ğŸ“¤ æ­£åœ¨åˆ›å»ºé€šçŸ¥: ${title}`);
                const result = await apiRequest('POST', apiBaseInput.value, data);
                addLog(`âœ… é€šçŸ¥åˆ›å»ºæˆåŠŸ: ID ${result.id}`);
            } catch (error) {
                // é”™è¯¯å·²åœ¨ apiRequest ä¸­è®°å½•
            }
        });

        // è·å–é€šçŸ¥åˆ—è¡¨
        getNotifBtn.addEventListener('click', async () => {
            try {
                addLog('ğŸ“¥ æ­£åœ¨è·å–é€šçŸ¥åˆ—è¡¨...');
                const result = await apiRequest('GET', apiBaseInput.value);
                addLog(`âœ… è·å–é€šçŸ¥æˆåŠŸ: å…± ${result.data.length} æ¡`);
                addLog(`é€šçŸ¥åˆ—è¡¨: ${JSON.stringify(result.data, null, 2)}`);
            } catch (error) {
                // é”™è¯¯å·²åœ¨ apiRequest ä¸­è®°å½•
            }
        });

        // è·å–æœªè¯»é€šçŸ¥
        getNewNotifBtn.addEventListener('click', async () => {
            try {
                addLog('ğŸ“¥ æ­£åœ¨è·å–æœªè¯»é€šçŸ¥...');
                const result = await apiRequest('GET', `${apiBaseInput.value}/new`);
                addLog(`âœ… è·å–æœªè¯»é€šçŸ¥æˆåŠŸ: å…± ${result.length} æ¡`);
                addLog(`æœªè¯»é€šçŸ¥: ${JSON.stringify(result, null, 2)}`);
            } catch (error) {
                // é”™è¯¯å·²åœ¨ apiRequest ä¸­è®°å½•
            }
        });

        // æ¸…ç©ºæ—¥å¿—
        clearLogBtn.addEventListener('click', () => {
            logDiv.textContent = '';
            notificationsDiv.innerHTML = '';
        });

        // åˆå§‹åŒ–
        addLog('ğŸš€ WebSocket æµ‹è¯•å·¥å…·å·²åŠ è½½');
        addLog('æç¤º: è¯·å…ˆè·å–æœ‰æ•ˆçš„JWT Tokenï¼Œç„¶åè¾“å…¥åç‚¹å‡»è¿æ¥');
    </script>
</body>
</html> 