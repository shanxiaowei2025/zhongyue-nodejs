<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通知系统 WebSocket 测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .notification {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔔 通知系统 WebSocket 测试工具</h1>
        
        <!-- 连接配置 -->
        <div class="section">
            <h3>1. 连接配置</h3>
            <label>WebSocket 服务器地址:</label>
            <input type="text" id="serverUrl" value="http://localhost:3000/ws" placeholder="WebSocket服务器地址">
            
            <label>JWT Token:</label>
            <input type="text" id="jwtToken" placeholder="请输入JWT Token">
            
            <div id="connectionStatus" class="status disconnected">
                状态: 未连接
            </div>
            
            <button id="connectBtn">连接 WebSocket</button>
            <button id="disconnectBtn" disabled>断开连接</button>
        </div>

        <!-- API 测试 -->
        <div class="section">
            <h3>2. 通知API测试</h3>
            <label>API 基础地址:</label>
            <input type="text" id="apiBase" value="http://localhost:3000/api/notifications" placeholder="API基础地址">
            
            <div style="margin-top: 15px;">
                <h4>创建通知</h4>
                <input type="text" id="notifTitle" placeholder="通知标题" value="测试通知">
                <textarea id="notifContent" placeholder="通知内容" rows="3">这是一条测试通知，用于验证WebSocket推送功能。</textarea>
                <input type="text" id="targetUsers" placeholder="目标用户ID (逗号分隔，如: 1,2,3)">
                <button id="createNotifBtn">创建并推送通知</button>
            </div>
            
            <div style="margin-top: 15px;">
                <h4>获取我的通知</h4>
                <button id="getNotifBtn">获取通知列表</button>
                <button id="getNewNotifBtn">获取未读通知</button>
            </div>
        </div>

        <!-- 接收到的通知 -->
        <div class="section">
            <h3>3. 实时通知</h3>
            <div id="notifications"></div>
        </div>

        <!-- 日志 -->
        <div class="section">
            <h3>4. 连接日志</h3>
            <button id="clearLogBtn">清空日志</button>
            <div id="log" class="log"></div>
        </div>
    </div>

    <!-- Socket.IO 客户端库 -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let socket = null;
        let isConnected = false;

        // DOM 元素
        const serverUrlInput = document.getElementById('serverUrl');
        const jwtTokenInput = document.getElementById('jwtToken');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const logDiv = document.getElementById('log');
        const notificationsDiv = document.getElementById('notifications');

        // API 相关元素
        const apiBaseInput = document.getElementById('apiBase');
        const notifTitleInput = document.getElementById('notifTitle');
        const notifContentInput = document.getElementById('notifContent');
        const targetUsersInput = document.getElementById('targetUsers');
        const createNotifBtn = document.getElementById('createNotifBtn');
        const getNotifBtn = document.getElementById('getNotifBtn');
        const getNewNotifBtn = document.getElementById('getNewNotifBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');

        // 日志函数
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // 更新连接状态
        function updateConnectionStatus(connected) {
            isConnected = connected;
            connectionStatus.textContent = connected ? '状态: 已连接' : '状态: 未连接';
            connectionStatus.className = `status ${connected ? 'connected' : 'disconnected'}`;
            connectBtn.disabled = connected;
            disconnectBtn.disabled = !connected;
        }

        // 连接 WebSocket
        connectBtn.addEventListener('click', () => {
            const serverUrl = serverUrlInput.value.trim();
            const token = jwtTokenInput.value.trim();

            if (!serverUrl) {
                alert('请输入WebSocket服务器地址');
                return;
            }

            if (!token) {
                alert('请输入JWT Token');
                return;
            }

            addLog(`正在连接到 ${serverUrl}...`);

            // 创建 Socket.IO 连接
            socket = io(serverUrl, {
                auth: {
                    token: token
                }
            });

            // 连接成功
            socket.on('connect', () => {
                addLog('✅ WebSocket 连接成功');
                addLog(`Socket ID: ${socket.id}`);
                updateConnectionStatus(true);
            });

            // 连接失败
            socket.on('connect_error', (error) => {
                addLog(`❌ 连接失败: ${error.message}`);
                updateConnectionStatus(false);
            });

            // 断开连接
            socket.on('disconnect', (reason) => {
                addLog(`🔌 连接断开: ${reason}`);
                updateConnectionStatus(false);
            });

            // 接收新通知
            socket.on('new-notification', (notification) => {
                addLog(`📬 收到新通知: ${notification.title}`);
                addNotificationToUI(notification);
            });

            // 其他事件
            socket.onAny((eventName, ...args) => {
                if (eventName !== 'new-notification') {
                    addLog(`📨 收到事件 ${eventName}: ${JSON.stringify(args)}`);
                }
            });
        });

        // 断开连接
        disconnectBtn.addEventListener('click', () => {
            if (socket) {
                socket.disconnect();
                socket = null;
                addLog('🔌 主动断开连接');
                updateConnectionStatus(false);
            }
        });

        // 添加通知到UI
        function addNotificationToUI(notification) {
            const notifDiv = document.createElement('div');
            notifDiv.className = 'notification';
            notifDiv.innerHTML = `
                <strong>${notification.title}</strong><br>
                ${notification.content}<br>
                <small>时间: ${new Date().toLocaleString()}</small>
            `;
            notificationsDiv.insertBefore(notifDiv, notificationsDiv.firstChild);
        }

        // API 请求辅助函数
        async function apiRequest(method, url, data = null) {
            const token = jwtTokenInput.value.trim();
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(url, options);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || '请求失败');
                }
                
                return result;
            } catch (error) {
                addLog(`❌ API请求失败: ${error.message}`);
                throw error;
            }
        }

        // 创建通知
        createNotifBtn.addEventListener('click', async () => {
            const title = notifTitleInput.value.trim();
            const content = notifContentInput.value.trim();
            const targetUsers = targetUsersInput.value.trim();

            if (!title || !content) {
                alert('请填写标题和内容');
                return;
            }

            const data = {
                title: title,
                content: content,
                type: 'test'
            };

            // 解析目标用户
            if (targetUsers) {
                data.targetUsers = targetUsers.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
            }

            try {
                addLog(`📤 正在创建通知: ${title}`);
                const result = await apiRequest('POST', apiBaseInput.value, data);
                addLog(`✅ 通知创建成功: ID ${result.id}`);
            } catch (error) {
                // 错误已在 apiRequest 中记录
            }
        });

        // 获取通知列表
        getNotifBtn.addEventListener('click', async () => {
            try {
                addLog('📥 正在获取通知列表...');
                const result = await apiRequest('GET', apiBaseInput.value);
                addLog(`✅ 获取通知成功: 共 ${result.data.length} 条`);
                addLog(`通知列表: ${JSON.stringify(result.data, null, 2)}`);
            } catch (error) {
                // 错误已在 apiRequest 中记录
            }
        });

        // 获取未读通知
        getNewNotifBtn.addEventListener('click', async () => {
            try {
                addLog('📥 正在获取未读通知...');
                const result = await apiRequest('GET', `${apiBaseInput.value}/new`);
                addLog(`✅ 获取未读通知成功: 共 ${result.length} 条`);
                addLog(`未读通知: ${JSON.stringify(result, null, 2)}`);
            } catch (error) {
                // 错误已在 apiRequest 中记录
            }
        });

        // 清空日志
        clearLogBtn.addEventListener('click', () => {
            logDiv.textContent = '';
            notificationsDiv.innerHTML = '';
        });

        // 初始化
        addLog('🚀 WebSocket 测试工具已加载');
        addLog('提示: 请先获取有效的JWT Token，然后输入后点击连接');
    </script>
</body>
</html> 